{% extends "base.html" %}

{% block title %}משחקים קרובים - אצטדיון סמי עופר{% endblock %}

{% block extra_css %}
<style>
    .fab-container {
        display: block;
    }
</style>
{% endblock %}

{% macro render_game_card(game, index, section) %}
{% set game_date = datetime.fromisoformat(game.scraped_date_time) %}
<div class="game-card" data-section="{{ section }}" data-game-id="{{ game.game_id }}">
    <div class="game-card-header">
        <div class="game-number">#{{ index }}</div>
        <div class="game-date-time">
            <div class="game-date">
                <i class="fas fa-calendar"></i>
                {{ game_date.strftime('%d.%m.%Y') }}
            </div>
            <div class="game-day">
                {{ game_date | babel_format_day_heb }}
                <i class="fas fa-clock"></i>
                {{ game_date.strftime('%H:%M') }}
            </div>
        </div>
        <!-- League Badge in header for all games -->
        <div class="league-badge league-badge-header">
            <i class="fas fa-trophy"></i>
            {{ game.league }}
        </div>
    </div>

    <div class="game-card-body">

        <!-- Teams -->
        <div class="teams-container">
            <!-- Home Team -->
            <div class="team home-team">
                <img src="assets/teams/{{ game.home_team_en }}.png" alt="{{ game.home_team }}" class="team-logo">
                <a href="{{ game.home_team_url }}" target="_blank" class="team-name">{{ game.home_team }}</a>
                <span class="team-label">בית</span>
            </div>

            <!-- VS -->
            <div class="vs-divider">
                <span>VS</span>
            </div>

            <!-- Guest Team -->
            <div class="team guest-team">
                <img src="assets/teams/{{ game.guest_team_en }}.png" alt="{{ game.guest_team }}" class="team-logo">
                {% if game.guest_team_url != '' %}
                    <a href="{{ game.guest_team_url }}" target="_blank" class="team-name">{{ game.guest_team }}</a>
                {% else %}
                    <span class="team-name">{{ game.guest_team }}</span>
                {% endif %}
                <span class="team-label">חוץ</span>
            </div>
        </div>

        <!-- Game Info -->
        <div class="game-info-grid">
            <!-- Attendance Stats Stacked -->
            <div class="info-stack">
                <div class="info-item">
                    <i class="fas fa-user-friends"></i>
                    <div class="info-content">
                        <span class="info-label">מספר אוהדים</span>
                        <span class="info-value {% if game.specs_number == 0 %}warning{% endif %}">
                            {{ "{:,}".format(game.specs_number) }}
                        </span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-chart-line"></i>
                    <div class="info-content">
                        <span class="info-label">בפועל</span>
                        <span class="info-value">{{ "{:,}".format(game.post_specs_number) }}</span>
                    </div>
                </div>
            </div>

            <!-- Crowd Size & Poll Stacked -->
            <div class="info-stack">
                <div class="info-item">
                    <i class="fas fa-users"></i>
                    <div class="info-content">
                        <span class="info-label">גודל קהל</span>
                        <span class="info-value">{{ game.specs_word }}</span>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-poll"></i>
                    <div class="info-content">
                        <span class="info-label">סקר</span>
                        <span class="info-value">
                            {% if game.poll == 'on' %}
                                <i class="fas fa-check-circle text-success"></i>
                            {% else %}
                                <i class="fas fa-times-circle text-muted"></i>
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons Stacked -->
            <div class="info-stack buttons-stack">
                <button class="card-btn btn-edit" data-action="update"
                        data-game-id="{{ game.game_id }}"
                        data-league="{{ game.league }}"
                        data-game-date="{{ game_date.strftime('%d-%m-%Y') }}"
                        data-game-time="{{ game_date.strftime('%H:%M') }}"
                        data-home-team="{{ game.home_team }}"
                        data-guest-team="{{ game.guest_team }}"
                        data-specs-word="{{ game.specs_word }}"
                        data-sched-time="{{ game.sched_time }}"
                        data-specs-number="{{ game.specs_number }}"
                        data-post-specs-number="{{ game.post_specs_number }}"
                        data-poll="{{ game.poll }}"
                        data-notes="{{ game.notes }}">
                    <i class="fas fa-edit"></i>
                    <span>עדכן</span>
                </button>
                <button class="card-btn btn-send" data-game-id="{{ game.game_id }}">
                    <i class="fas fa-paper-plane"></i>
                    <span>שלח</span>
                </button>
                <button class="card-btn btn-delete" data-action="delete"
                        data-game-id="{{ game.game_id }}"
                        data-home-team="{{ game.home_team }}"
                        data-guest-team="{{ game.guest_team }}">
                    <i class="fas fa-trash"></i>
                    <span>מחק</span>
                </button>
            </div>
        </div>

        <!-- Notes -->
        {% if game.notes %}
        <div class="game-notes">
            <i class="fas fa-sticky-note"></i>
            <span>{{ game.notes }}</span>
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% block content %}
<div class="container">
    <!-- Result Message Area -->
    <div id="result_action"></div>

    <!-- Upcoming Games Section -->
    <section class="games-section">
        <div class="section-header" id="upcoming-header">
            <div class="section-title">
                <i class="fas fa-calendar-check section-icon"></i>
                <h2>משחקים קרובים</h2>
                <span class="badge">{{ mygames[0]|length }}</span>
            </div>
            <button class="toggle-btn" data-target="upcoming-content">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="section-content" id="upcoming-content">
            {% if mygames[0]|length > 0 %}
                {% for game in mygames[0] %}
                    {{ render_game_card(game, loop.index, 'upcoming') }}
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <p>אין משחקים קרובים</p>
                </div>
            {% endif %}
        </div>
    </section>

    <!-- Past Games Section -->
    <section class="games-section">
        <div class="section-header collapsed" id="past-header">
            <div class="section-title">
                <i class="fas fa-history section-icon"></i>
                <h2>משחקי עבר</h2>
                <span class="badge">{{ mygames[1]|length }}</span>
            </div>
            <button class="toggle-btn" data-target="past-content">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="section-content collapsed" id="past-content">
            {% if mygames[1]|length > 0 %}
                {% for game in mygames[1] %}
                    {{ render_game_card(game, loop.index, 'past') }}
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <p>אין משחקי עבר</p>
                </div>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Toggle section collapse
    $('.section-header').on('click', function() {
        const toggleBtn = $(this).find('.toggle-btn');
        const target = toggleBtn.data('target');
        const content = $('#' + target);

        $(this).toggleClass('collapsed');
        content.toggleClass('collapsed');
        toggleBtn.find('i').toggleClass('fa-chevron-down fa-chevron-up');
    });

    // FAB Add button (Desktop)
    $('#fab-add').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $.post("/action", { "add": JSON.stringify({ "action": "add" }) })
            .done(function(data) {
                showModal(data);
            });
    });

    // Mobile Add button
    $('#fab-add-mobile').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $.post("/action", { "add": JSON.stringify({ "action": "add" }) })
            .done(function(data) {
                showModal(data);
            });
    });

    // Edit button
    $('.btn-edit').on('click', function() {
        const card = $(this).closest('.game-card');
        card.addClass('highlight');

        const data = {
            action: 'update'
        };

        $.each($(this).data(), function(key, value) {
            data[key] = value;
        });

        $.post("/action", { "update": JSON.stringify(data) })
            .done(function(response) {
                showModal(response);
            });
    });

    // Delete button
    $('.btn-delete').on('click', function() {
        const card = $(this).closest('.game-card');
        const homeTeam = $(this).data('home-team');
        const guestTeam = $(this).data('guest-team');

        card.addClass('highlight');

        const data = {
            action: 'delete',
            gameId: $(this).data('game-id'),
            homeTeam: homeTeam,
            guestTeam: guestTeam
        };

        $.post("/action", { "delete": JSON.stringify(data) })
            .done(function(response) {
                showModal(response);
            });
    });

    // Send button
    $('.btn-send').on('click', function() {
        const card = $(this).closest('.game-card');
        const gameId = $(this).data('game-id');

        // Find team names from the card
        const homeTeam = card.find('.home-team .team-name').text();
        const guestTeam = card.find('.guest-team .team-name').text();

        card.addClass('highlight');

        const data = {
            action: 'send',
            gameId: gameId,
            homeTeam: homeTeam,
            guestTeam: guestTeam
        };

        $.post("/action", { "send": JSON.stringify(data) })
            .done(function(response) {
                showModal(response);
            });
    });

    // Show modal for action forms
    function showModal(content) {
        const modal = $('<div class="modal-overlay"></div>');
        const modalContent = $('<div class="modal-content"></div>');
        const modalInner = $('<div class="modal-inner"></div>');
        const closeBtn = $('<button class="modal-close"><i class="fas fa-times"></i></button>');

        modalInner.html(content);
        modalContent.append(closeBtn);
        modalContent.append(modalInner);
        modal.append(modalContent);
        $('body').append(modal);

        setTimeout(() => modal.addClass('active'), 10);

        closeBtn.on('click', function() {
            closeModal(modal);
        });

        modal.on('click', function(e) {
            if ($(e.target).is('.modal-overlay')) {
                closeModal(modal);
            }
        });
    }

    function closeModal(modal) {
        modal.removeClass('active');
        setTimeout(() => modal.remove(), 300);
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = $('#toast');
        toast.removeClass('success error info warning').addClass(type);
        toast.text(message);
        toast.addClass('show');

        setTimeout(() => {
            toast.removeClass('show');
        }, 3000);
    }

    // Expose to global scope for action.html forms
    window.showToast = showToast;
});
</script>
{% endblock %}
